const Web3 = require('web3')
const rpcUrl = "http://localhost:8000"
const web3 = new Web3(rpcUrl)

var Accounts = require('web3-eth-accounts')
// var accounts= new Accounts(rpcURL)
var keyth = require('keythereum')
const tx = require('ethereumjs-tx').Transaction
const ContractDatabase = require('./app/models/contract')

const accountOnePrivateKey = process.env.PrivateKeyofAccountOne

var abi = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "uuid",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "fullName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "studentEmail",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "studentID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "universityName",
				"type": "string"
			}
		],
		"name": "logCertificateVerification",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "registrationID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "accountAddress",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "universityName",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "universityEmail",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "universityAddress",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "contactNumber",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "role",
				"type": "string"
			}
		],
		"name": "logFormSubmission",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "creator",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_registrationID",
				"type": "string"
			}
		],
		"name": "getRegistrationInformation",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_uuid",
				"type": "string"
			}
		],
		"name": "getVerifiedCertificateInformation",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_registrationID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_accountAddress",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_universityName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_universityEmail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_universityAddress",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_contactNumber",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_role",
				"type": "string"
			}
		],
		"name": "storeRegistrationInfo",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_uuid",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_fullName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_studentEmail",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_studentID",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_universityName",
				"type": "string"
			}
		],
		"name": "storeVerificatedCertificateInfo",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "verifier",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

var bytecode = "0x" +"608060405234801561001057600080fd5b5033600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611599806100616000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c806302d05d3f146100675780632b7ac3f3146100855780632df94d0c146100a35780639a3a10e8146100d9578063bd74f7cb1461010d578063db2f319814610129575b600080fd5b61006f610145565b60405161007c9190611212565b60405180910390f35b61008d61016b565b60405161009a9190611212565b60405180910390f35b6100bd60048036038101906100b89190610ea9565b610191565b6040516100d097969594939291906112a3565b60405180910390f35b6100f360048036038101906100ee9190610ea9565b610670565b60405161010495949392919061122d565b60405180910390f35b61012760048036038101906101229190610ff9565b6109ec565b005b610143600480360381019061013e9190610ef2565b610bb2565b005b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60608060608060608060606000886040516101ac91906111fb565b90815260200160405180910390206000016000896040516101cd91906111fb565b908152602001604051809103902060010160008a6040516101ee91906111fb565b908152602001604051809103902060020160008b60405161020f91906111fb565b908152602001604051809103902060030160008c60405161023091906111fb565b908152602001604051809103902060040160008d60405161025191906111fb565b908152602001604051809103902060050160008e60405161027291906111fb565b908152602001604051809103902060060186805461028f90611454565b80601f01602080910402602001604051908101604052809291908181526020018280546102bb90611454565b80156103085780601f106102dd57610100808354040283529160200191610308565b820191906000526020600020905b8154815290600101906020018083116102eb57829003601f168201915b5050505050965085805461031b90611454565b80601f016020809104026020016040519081016040528092919081815260200182805461034790611454565b80156103945780601f1061036957610100808354040283529160200191610394565b820191906000526020600020905b81548152906001019060200180831161037757829003601f168201915b505050505095508480546103a790611454565b80601f01602080910402602001604051908101604052809291908181526020018280546103d390611454565b80156104205780601f106103f557610100808354040283529160200191610420565b820191906000526020600020905b81548152906001019060200180831161040357829003601f168201915b5050505050945083805461043390611454565b80601f016020809104026020016040519081016040528092919081815260200182805461045f90611454565b80156104ac5780601f10610481576101008083540402835291602001916104ac565b820191906000526020600020905b81548152906001019060200180831161048f57829003601f168201915b505050505093508280546104bf90611454565b80601f01602080910402602001604051908101604052809291908181526020018280546104eb90611454565b80156105385780601f1061050d57610100808354040283529160200191610538565b820191906000526020600020905b81548152906001019060200180831161051b57829003601f168201915b5050505050925081805461054b90611454565b80601f016020809104026020016040519081016040528092919081815260200182805461057790611454565b80156105c45780601f10610599576101008083540402835291602001916105c4565b820191906000526020600020905b8154815290600101906020018083116105a757829003601f168201915b505050505091508080546105d790611454565b80601f016020809104026020016040519081016040528092919081815260200182805461060390611454565b80156106505780601f1061062557610100808354040283529160200191610650565b820191906000526020600020905b81548152906001019060200180831161063357829003601f168201915b505050505090509650965096509650965096509650919395979092949650565b606080606080606060018660405161068891906111fb565b90815260200160405180910390206000016001876040516106a991906111fb565b90815260200160405180910390206001016001886040516106ca91906111fb565b90815260200160405180910390206002016001896040516106eb91906111fb565b908152602001604051809103902060030160018a60405161070c91906111fb565b908152602001604051809103902060040184805461072990611454565b80601f016020809104026020016040519081016040528092919081815260200182805461075590611454565b80156107a25780601f10610777576101008083540402835291602001916107a2565b820191906000526020600020905b81548152906001019060200180831161078557829003601f168201915b505050505094508380546107b590611454565b80601f01602080910402602001604051908101604052809291908181526020018280546107e190611454565b801561082e5780601f106108035761010080835404028352916020019161082e565b820191906000526020600020905b81548152906001019060200180831161081157829003601f168201915b5050505050935082805461084190611454565b80601f016020809104026020016040519081016040528092919081815260200182805461086d90611454565b80156108ba5780601f1061088f576101008083540402835291602001916108ba565b820191906000526020600020905b81548152906001019060200180831161089d57829003601f168201915b505050505092508180546108cd90611454565b80601f01602080910402602001604051908101604052809291908181526020018280546108f990611454565b80156109465780601f1061091b57610100808354040283529160200191610946565b820191906000526020600020905b81548152906001019060200180831161092957829003601f168201915b5050505050915080805461095990611454565b80601f016020809104026020016040519081016040528092919081815260200182805461098590611454565b80156109d25780601f106109a7576101008083540402835291602001916109d2565b820191906000526020600020905b8154815290600101906020018083116109b557829003601f168201915b505050505090509450945094509450945091939590929450565b866000886040516109fd91906111fb565b90815260200160405180910390206000019080519060200190610a21929190610d96565b5085600088604051610a3391906111fb565b90815260200160405180910390206001019080519060200190610a57929190610d96565b5084600088604051610a6991906111fb565b90815260200160405180910390206002019080519060200190610a8d929190610d96565b5083600088604051610a9f91906111fb565b90815260200160405180910390206003019080519060200190610ac3929190610d96565b5082600088604051610ad591906111fb565b90815260200160405180910390206004019080519060200190610af9929190610d96565b5081600088604051610b0b91906111fb565b90815260200160405180910390206005019080519060200190610b2f929190610d96565b5080600088604051610b4191906111fb565b90815260200160405180910390206006019080519060200190610b65929190610d96565b507ffcc79a4e0c5c97e3c0f25b2fbb0d5981e2999bc6773a520c041f3059b8004a8687878787878787604051610ba197969594939291906112a3565b60405180910390a150505050505050565b3373ffffffffffffffffffffffffffffffffffffffff16600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610c42576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c3990611343565b60405180910390fd5b84600186604051610c5391906111fb565b90815260200160405180910390206000019080519060200190610c77929190610d96565b5083600186604051610c8991906111fb565b90815260200160405180910390206001019080519060200190610cad929190610d96565b5082600186604051610cbf91906111fb565b90815260200160405180910390206002019080519060200190610ce3929190610d96565b5081600186604051610cf591906111fb565b90815260200160405180910390206003019080519060200190610d19929190610d96565b5080600186604051610d2b91906111fb565b90815260200160405180910390206004019080519060200190610d4f929190610d96565b507ff95ac76b9859572bef8a55c2f8b6c535a525cf5710d9afd01a33bfb9bd256b998585858585604051610d8795949392919061122d565b60405180910390a15050505050565b828054610da290611454565b90600052602060002090601f016020900481019282610dc45760008555610e0b565b82601f10610ddd57805160ff1916838001178555610e0b565b82800160010185558215610e0b579182015b82811115610e0a578251825591602001919060010190610def565b5b509050610e189190610e1c565b5090565b5b80821115610e35576000816000905550600101610e1d565b5090565b6000610e4c610e4784611388565b611363565b905082815260208101848484011115610e6857610e6761151a565b5b610e73848285611412565b509392505050565b600082601f830112610e9057610e8f611515565b5b8135610ea0848260208601610e39565b91505092915050565b600060208284031215610ebf57610ebe611524565b5b600082013567ffffffffffffffff811115610edd57610edc61151f565b5b610ee984828501610e7b565b91505092915050565b600080600080600060a08688031215610f0e57610f0d611524565b5b600086013567ffffffffffffffff811115610f2c57610f2b61151f565b5b610f3888828901610e7b565b955050602086013567ffffffffffffffff811115610f5957610f5861151f565b5b610f6588828901610e7b565b945050604086013567ffffffffffffffff811115610f8657610f8561151f565b5b610f9288828901610e7b565b935050606086013567ffffffffffffffff811115610fb357610fb261151f565b5b610fbf88828901610e7b565b925050608086013567ffffffffffffffff811115610fe057610fdf61151f565b5b610fec88828901610e7b565b9150509295509295909350565b600080600080600080600060e0888a03121561101857611017611524565b5b600088013567ffffffffffffffff8111156110365761103561151f565b5b6110428a828b01610e7b565b975050602088013567ffffffffffffffff8111156110635761106261151f565b5b61106f8a828b01610e7b565b965050604088013567ffffffffffffffff8111156110905761108f61151f565b5b61109c8a828b01610e7b565b955050606088013567ffffffffffffffff8111156110bd576110bc61151f565b5b6110c98a828b01610e7b565b945050608088013567ffffffffffffffff8111156110ea576110e961151f565b5b6110f68a828b01610e7b565b93505060a088013567ffffffffffffffff8111156111175761111661151f565b5b6111238a828b01610e7b565b92505060c088013567ffffffffffffffff8111156111445761114361151f565b5b6111508a828b01610e7b565b91505092959891949750929550565b611168816113e0565b82525050565b6000611179826113b9565b61118381856113c4565b9350611193818560208601611421565b61119c81611529565b840191505092915050565b60006111b2826113b9565b6111bc81856113d5565b93506111cc818560208601611421565b80840191505092915050565b60006111e56015836113c4565b91506111f08261153a565b602082019050919050565b600061120782846111a7565b915081905092915050565b6000602082019050611227600083018461115f565b92915050565b600060a0820190508181036000830152611247818861116e565b9050818103602083015261125b818761116e565b9050818103604083015261126f818661116e565b90508181036060830152611283818561116e565b90508181036080830152611297818461116e565b90509695505050505050565b600060e08201905081810360008301526112bd818a61116e565b905081810360208301526112d1818961116e565b905081810360408301526112e5818861116e565b905081810360608301526112f9818761116e565b9050818103608083015261130d818661116e565b905081810360a0830152611321818561116e565b905081810360c0830152611335818461116e565b905098975050505050505050565b6000602082019050818103600083015261135c816111d8565b9050919050565b600061136d61137e565b90506113798282611486565b919050565b6000604051905090565b600067ffffffffffffffff8211156113a3576113a26114e6565b5b6113ac82611529565b9050602081019050919050565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b60006113eb826113f2565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b82818337600083830152505050565b60005b8381101561143f578082015181840152602081019050611424565b8381111561144e576000848401525b50505050565b6000600282049050600182168061146c57607f821691505b602082108114156114805761147f6114b7565b5b50919050565b61148f82611529565b810181811067ffffffffffffffff821117156114ae576114ad6114e6565b5b80604052505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4d6573736167652066726f6d205665726966696572000000000000000000000060008201525056fea2646970667358221220b2413d01995f80cde78f1cf466068ac35398f8b085656464cf5e355fa1340bc064736f6c63430008070033";


function deploySmartContract(){
    web3.eth.getAccounts().then(async function (accounts){
        var contractAbi = new web3.eth.Contract(abi)
        var deployContract = await contractAbi.deploy({
            data: bytecode
        }).encodeABI();

        const tx = {
            chainId: 87253,
            data: deployContract,
            gas: 8000000
        }

        var baseAccount = keyth.recover('ornab1', keyth.importFromFile(accounts[0], "./blockchain/data/")).toString('hex')

        web3.eth.accounts.signTransaction(tx, "0x" + accountOnePrivateKey).then(signed =>{
            web3.eth.sendSignedTransaction(signed.rawTransaction).on('receipt', async function(response){
                const contarctDatabaseStructure = new ContractDatabase({
                    blockHash: response.blockHash,
					blockNumber: response.blockNumber,
					contractAddress: response.contractAddress,
					cumulativeGasUsed: response.cumulativeGasUsed,
					from: response.from,
					gasUsed: response.gasUsed,
					logsBloom: response.logsBloom,
					status: response.status,
					to: response.to,
					transactionHash: response.transactionHash,
					transactionIndex: response.transactionIndex,
					type: response.type
                })


                const contractSave = await contarctDatabaseStructure.save()
                console.log(contractSave)
            })
        })
    })
}


module.exports = deploySmartContract